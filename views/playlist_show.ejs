<%- include('./include/_header') %>

<main class="pl-page">
  <div class="pl-layout">
    <aside class="pl-sidebar">
      <h2 class="pl-title">Playlist Ground</h2>
      <p class="pl-desc">다른 사람의 추천곡을 구경할 수 있는 공간</p>
    </aside>

    <section class="pl-main">
      <% if (!playlist || !playlist.tracks || !playlist.tracks.length) { %>
        <p class="pl-empty">
          아직 등록된 노래가 없습니다. TASTE에서 노래를 등록해 보세요!
        </p>
      <% } else { %>

        <div class="pl-disc">
          <div class="pl-disc-head">
            <div class="pl-disc-owner"><%= user.username %>의</div>
            <div class="pl-disc-label">PLAYLIST</div>
          </div>

          <ol class="pl-disc-tracks">
            <% playlist.tracks.forEach(function (track, index) { %>
              <li
                class="pl-disc-track"
                data-audio="<%= track.audioUrl || '' %>"
              >
                <span class="pl-track-index"><%= index + 1 %>.</span>
                <span class="pl-track-title">
                  <%= track.title %>
                  <% if (track.artist) { %> – <%= track.artist %><% } %>
                </span>

                <% if (track.audioUrl) { %>
                  <button
                    type="button"
                    class="pl-track-play-btn"
                    aria-label="재생"
                  >
                    ▶
                  </button>
                <% } else { %>
                  <button
                    type="button"
                    class="pl-track-play-btn pl-track-play-btn--disabled"
                    disabled
                    title="음원 정보가 없습니다."
                  >
                    ▶
                  </button>
                <% } %>
              </li>
            <% }); %>
          </ol>
        </div>

        <audio id="pl-audio" preload="none"></audio>

        <div class="pl-comments-wrap">
          <hr class="pl-divider" />

          <div class="pl-comment-header">
            <span class="pl-comment-col">닉네임</span>
            <span class="pl-comment-col">왜 이 노래 뭐임?</span>
          </div>

          <form class="pl-comment-form" action="#" method="POST">
            <input
              type="text"
              name="comment"
              class="pl-comment-input"
              placeholder="댓글 작성"
            />
          </form>
        </div>
      <% } %>
    </section>
  </div>
</main>

<%- include('./include/_footer') %>

<script>
  (function () {
    var audio = document.getElementById("pl-audio");
    if (!audio) return;

    var rows = document.querySelectorAll(".pl-disc-track");
    var currentBtn = null;

    rows.forEach(function (row) {
      var btn = row.querySelector(".pl-track-play-btn");
      if (!btn || btn.disabled) return;

      var src = row.getAttribute("data-audio");
      if (!src) {
        btn.disabled = true;
        btn.classList.add("pl-track-play-btn--disabled");
        return;
      }

      btn.addEventListener("click", function () {
        if (currentBtn === btn && !audio.paused) {
          audio.pause();
          btn.classList.remove("is-playing");
          row.classList.remove("is-active");
          return;
        }

        document
          .querySelectorAll(".pl-disc-track.is-active")
          .forEach(function (r) {
            r.classList.remove("is-active");
          });

        document
          .querySelectorAll(".pl-track-play-btn.is-playing")
          .forEach(function (b) {
            b.classList.remove("is-playing");
          });

        row.classList.add("is-active");
        btn.classList.add("is-playing");
        currentBtn = btn;

        audio.src = src;
        audio.play();
      });
    });

    audio.addEventListener("ended", function () {
      if (currentBtn) {
        currentBtn.classList.remove("is-playing");
      }
      document
        .querySelectorAll(".pl-disc-track.is-active")
        .forEach(function (r) {
          r.classList.remove("is-active");
        });
      currentBtn = null;
    });
  })();
</script>
